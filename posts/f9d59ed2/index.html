<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>mysql索引和优化机制 | 精进马大使</title><meta name="description" content="mysql索引和优化机制"><meta name="keywords" content="mysql,索引"><meta name="author" content="精进马大使"><meta name="copyright" content="精进马大使"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://jskblog.xyz/posts/f9d59ed2/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="mysql索引和优化机制"><meta name="twitter:description" content="mysql索引和优化机制"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/jingjin_1.jpg"><meta property="og:type" content="article"><meta property="og:title" content="mysql索引和优化机制"><meta property="og:url" content="http://jskblog.xyz/posts/f9d59ed2/"><meta property="og:site_name" content="精进马大使"><meta property="og:description" content="mysql索引和优化机制"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/jingjin_1.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="JVM OOM 汇总及介绍" href="http://jskblog.xyz/posts/91f0cf3/"><link rel="next" title="mysql锁机制优化汇总" href="http://jskblog.xyz/posts/cdbb5827/"><meta name="baidu-site-verification" content="&lt;meta name=&quot;baidu-site-verification&quot; content=&quot;m0FTCFBXUY&quot; /&gt;"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: {"languages":{"author":"作者: 精进马大使","link":"链接: http://jskblog.xyz/posts/f9d59ed2/","source":"来源: 精进马大使","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  copy_copyright_js: true
  
}</script></head><body><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">精进马大使</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主目录</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章列表</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@v1.1/photos/shikai.jpg" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">22</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">30</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">29</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主目录</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章列表</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#文章思路"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">文章思路</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#mysql架构"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">mysql架构</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#mysql架构图"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">mysql架构图</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#mysql机制介绍"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">mysql机制介绍</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#半双工连接"><span class="toc_mobile_items-number">2.2.1.</span> <span class="toc_mobile_items-text">半双工连接</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#缓存"><span class="toc_mobile_items-number">2.2.2.</span> <span class="toc_mobile_items-text">缓存</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#语法解析和预处理"><span class="toc_mobile_items-number">2.2.3.</span> <span class="toc_mobile_items-text">语法解析和预处理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#查询优化"><span class="toc_mobile_items-number">2.2.4.</span> <span class="toc_mobile_items-text">查询优化</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#查询执行引擎"><span class="toc_mobile_items-number">2.2.5.</span> <span class="toc_mobile_items-text">查询执行引擎</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#完整过程"><span class="toc_mobile_items-number">2.2.6.</span> <span class="toc_mobile_items-text">完整过程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#sql语句执行过程"><span class="toc_mobile_items-number">2.2.7.</span> <span class="toc_mobile_items-text">sql语句执行过程</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#索引数据结构"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">索引数据结构</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#二叉查找树"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">二叉查找树</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#平衡二叉树"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">平衡二叉树</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#B树"><span class="toc_mobile_items-number">3.3.</span> <span class="toc_mobile_items-text">B树</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#B-树"><span class="toc_mobile_items-number">3.4.</span> <span class="toc_mobile_items-text">B+树</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#介绍B-树和mysql页概念"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">介绍B+树和mysql页概念</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#mysql页概念"><span class="toc_mobile_items-number">4.1.</span> <span class="toc_mobile_items-text">mysql页概念</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#mysql的B-树"><span class="toc_mobile_items-number">4.2.</span> <span class="toc_mobile_items-text">mysql的B+树</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#innodb和myisam的索引"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">innodb和myisam的索引</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#myisam的索引"><span class="toc_mobile_items-number">5.1.</span> <span class="toc_mobile_items-text">myisam的索引</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#主键索引"><span class="toc_mobile_items-number">5.1.1.</span> <span class="toc_mobile_items-text">主键索引</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#辅助索引"><span class="toc_mobile_items-number">5.1.2.</span> <span class="toc_mobile_items-text">辅助索引</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#innodb的索引"><span class="toc_mobile_items-number">5.2.</span> <span class="toc_mobile_items-text">innodb的索引</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#innodb的主键索引"><span class="toc_mobile_items-number">5.2.1.</span> <span class="toc_mobile_items-text">innodb的主键索引</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#innodb的辅助索引"><span class="toc_mobile_items-number">5.2.2.</span> <span class="toc_mobile_items-text">innodb的辅助索引</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#innodb的联合索引"><span class="toc_mobile_items-number">5.2.3.</span> <span class="toc_mobile_items-text">innodb的联合索引</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#innodb的覆盖索引"><span class="toc_mobile_items-number">5.2.4.</span> <span class="toc_mobile_items-text">innodb的覆盖索引</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#innodb的哈希索引"><span class="toc_mobile_items-number">5.2.5.</span> <span class="toc_mobile_items-text">innodb的哈希索引</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#索引代价和使用条件"><span class="toc_mobile_items-number">5.3.</span> <span class="toc_mobile_items-text">索引代价和使用条件</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#代价"><span class="toc_mobile_items-number">5.3.1.</span> <span class="toc_mobile_items-text">代价</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#适用条件"><span class="toc_mobile_items-number">5.3.2.</span> <span class="toc_mobile_items-text">适用条件</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#innodb中的索引优化和场景优化方案"><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">innodb中的索引优化和场景优化方案</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#不使用null的原因"><span class="toc_mobile_items-number">6.1.</span> <span class="toc_mobile_items-text">不使用null的原因</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#count的使用"><span class="toc_mobile_items-number">6.2.</span> <span class="toc_mobile_items-text">count的使用</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#索引优化汇总"><span class="toc_mobile_items-number">6.3.</span> <span class="toc_mobile_items-text">索引优化汇总</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#为什么性别不能用作索引"><span class="toc_mobile_items-number">6.3.1.</span> <span class="toc_mobile_items-text">为什么性别不能用作索引</span></a></li></ol></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#文章思路"><span class="toc-number">1.</span> <span class="toc-text">文章思路</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mysql架构"><span class="toc-number">2.</span> <span class="toc-text">mysql架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql架构图"><span class="toc-number">2.1.</span> <span class="toc-text">mysql架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql机制介绍"><span class="toc-number">2.2.</span> <span class="toc-text">mysql机制介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#半双工连接"><span class="toc-number">2.2.1.</span> <span class="toc-text">半双工连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存"><span class="toc-number">2.2.2.</span> <span class="toc-text">缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#语法解析和预处理"><span class="toc-number">2.2.3.</span> <span class="toc-text">语法解析和预处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询优化"><span class="toc-number">2.2.4.</span> <span class="toc-text">查询优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询执行引擎"><span class="toc-number">2.2.5.</span> <span class="toc-text">查询执行引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#完整过程"><span class="toc-number">2.2.6.</span> <span class="toc-text">完整过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sql语句执行过程"><span class="toc-number">2.2.7.</span> <span class="toc-text">sql语句执行过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#索引数据结构"><span class="toc-number">3.</span> <span class="toc-text">索引数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#二叉查找树"><span class="toc-number">3.1.</span> <span class="toc-text">二叉查找树</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#平衡二叉树"><span class="toc-number">3.2.</span> <span class="toc-text">平衡二叉树</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#B树"><span class="toc-number">3.3.</span> <span class="toc-text">B树</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#B-树"><span class="toc-number">3.4.</span> <span class="toc-text">B+树</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#介绍B-树和mysql页概念"><span class="toc-number">4.</span> <span class="toc-text">介绍B+树和mysql页概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql页概念"><span class="toc-number">4.1.</span> <span class="toc-text">mysql页概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql的B-树"><span class="toc-number">4.2.</span> <span class="toc-text">mysql的B+树</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#innodb和myisam的索引"><span class="toc-number">5.</span> <span class="toc-text">innodb和myisam的索引</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#myisam的索引"><span class="toc-number">5.1.</span> <span class="toc-text">myisam的索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#主键索引"><span class="toc-number">5.1.1.</span> <span class="toc-text">主键索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#辅助索引"><span class="toc-number">5.1.2.</span> <span class="toc-text">辅助索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#innodb的索引"><span class="toc-number">5.2.</span> <span class="toc-text">innodb的索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#innodb的主键索引"><span class="toc-number">5.2.1.</span> <span class="toc-text">innodb的主键索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#innodb的辅助索引"><span class="toc-number">5.2.2.</span> <span class="toc-text">innodb的辅助索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#innodb的联合索引"><span class="toc-number">5.2.3.</span> <span class="toc-text">innodb的联合索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#innodb的覆盖索引"><span class="toc-number">5.2.4.</span> <span class="toc-text">innodb的覆盖索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#innodb的哈希索引"><span class="toc-number">5.2.5.</span> <span class="toc-text">innodb的哈希索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引代价和使用条件"><span class="toc-number">5.3.</span> <span class="toc-text">索引代价和使用条件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#代价"><span class="toc-number">5.3.1.</span> <span class="toc-text">代价</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#适用条件"><span class="toc-number">5.3.2.</span> <span class="toc-text">适用条件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#innodb中的索引优化和场景优化方案"><span class="toc-number">6.</span> <span class="toc-text">innodb中的索引优化和场景优化方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#不使用null的原因"><span class="toc-number">6.1.</span> <span class="toc-text">不使用null的原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#count的使用"><span class="toc-number">6.2.</span> <span class="toc-text">count的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引优化汇总"><span class="toc-number">6.3.</span> <span class="toc-text">索引优化汇总</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么性别不能用作索引"><span class="toc-number">6.3.1.</span> <span class="toc-text">为什么性别不能用作索引</span></a></li></ol></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/jingjin_1.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">mysql索引和优化机制</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-12-17<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-12-17</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/mysql%E7%9F%A5%E8%AF%86/">mysql知识</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/mysql%E7%9F%A5%E8%AF%86/%E7%B4%A2%E5%BC%95/">索引</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">5.1k</span><span class="post-meta__separator">|</span><span>阅读时长: 15 分钟</span><span class="post-meta__separator">|</span><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="文章思路"><a href="#文章思路" class="headerlink" title="文章思路"></a>文章思路</h1><ol>
<li>介绍mysql架构</li>
<li>介绍索引数据结构</li>
<li>介绍B+树和mysql页概念</li>
<li>介绍innodb和myisam的索引</li>
<li>介绍innodb中的索引优化和场景优化方案</li>
</ol>
<h1 id="mysql架构"><a href="#mysql架构" class="headerlink" title="mysql架构"></a>mysql架构</h1><h2 id="mysql架构图"><a href="#mysql架构图" class="headerlink" title="mysql架构图"></a>mysql架构图</h2><p><img alt data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@v1.1/photos/mysql_connection.jpg" class="lozad"></p>
<p>第一层为客户端的连接认证，C/S都有此架构，诸如连接处理、授权认证、安全等<br>第二层为服务器层，包含MySQL的大多数核心服务功能 ，包括查询解析、分析、优化、缓存、内置函数、存储过程、触发器、视图等<br>第三层包含了存储引擎，服务器通过API与其通信，API规避了不同存储引擎的差异，不同存储引擎也不会互相通信，另外存储引擎不会去解析SQL(InnoDB是例外，它会解析外键定义，因为服务器本身没有实现该功能)  </p>
<p>每个连接都会在 MySQL 服务端产生一个线程（内部通过线程池管理线程），比如一个 select 语句进入，MySQL 首先会在查询缓存中查找是否缓存了这个 select 的结果集，如果没有则继续执行解析、优化、执行的过程；否则会之间从缓存中获取结果集。</p>
<h2 id="mysql机制介绍"><a href="#mysql机制介绍" class="headerlink" title="mysql机制介绍"></a>mysql机制介绍</h2><h3 id="半双工连接"><a href="#半双工连接" class="headerlink" title="半双工连接"></a>半双工连接</h3><p>mysql客户端/服务端通信协议是“半双工”的，即一旦一端开始发送消息，另一端必须接收完整消息才能响应它</p>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>命中缓存则不会解析和优化sql语句。缓存中包含任何用户自定义函数、存储函数、用户变量、临时表、mysql系统表，其查询不会被缓存。缓存在数据或者结构发生变化的时候会失效。缓存可以关闭和开启</p>
<h3 id="语法解析和预处理"><a href="#语法解析和预处理" class="headerlink" title="语法解析和预处理"></a>语法解析和预处理</h3><p>mysql会根据关键字对sql语句进行解析，并生成解析树。这个过程会进行验证解析，譬如sql语句关键字是否错误等。预处理则会查看解析树是否合法，譬如查询数据表和列是否存在</p>
<h3 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h3><p>mysql是使用基于成本的优化器，但其成本计算可能会出错，主要原因在可能统计信息不准确、优化和我们标准不一致（我们希望时间短，但优化器基于成本优化）等。成本统计信息包括：每张表或者索引的页面个数、索引的基数、索引和数据行的长度、索引的分布情况等等</p>
<h3 id="查询执行引擎"><a href="#查询执行引擎" class="headerlink" title="查询执行引擎"></a>查询执行引擎</h3><p>完成解析和优化，mysql会生成对应的执行计划。然后通过调用api去存储引擎查询数据</p>
<h3 id="完整过程"><a href="#完整过程" class="headerlink" title="完整过程"></a>完整过程</h3><ol>
<li>客户端向mysql服务器发送一条查询请求</li>
<li>服务器先看缓存，如果有直接返回</li>
<li>服务器进行解析、预处理、优化并生成执行计划</li>
<li>mysql根据执行计划调用存储引擎api执行查询</li>
<li>将结果返回给客户端，同时缓存结果</li>
</ol>
<h3 id="sql语句执行过程"><a href="#sql语句执行过程" class="headerlink" title="sql语句执行过程"></a>sql语句执行过程</h3><ol>
<li>FROM：对FROM子句中的表执行笛卡尔积(交叉联接)，生成虚拟表VT1。</li>
<li>ON：对VT1应用ON筛选器，只有那些使为真才被插入到TV2。</li>
<li>OUTER (JOIN):如果指定了OUTER JOIN(相对于CROSS JOIN或INNER JOIN)，保留表中未找到匹配的行将作为外部行添加到VT2，生成TV3。如果FROM子句包含两个以上的表，则对上一个联接生成的结果表和下一个表重复执行步骤1到步骤3，直到处理完所有的表位置。</li>
<li>WHERE：对TV3应用WHERE筛选器，只有使为true的行才插入TV4。</li>
<li>GROUP BY：按GROUP BY子句中的列列表对TV4中的行进行分组，生成TV5。</li>
<li>CUTE|ROLLUP：把超组插入VT5，生成VT6。</li>
<li>HAVING：对VT6应用HAVING筛选器，只有使为true的组插入到VT7。</li>
<li>SELECT：处理SELECT列表，产生VT8。</li>
<li>DISTINCT：将重复的行从VT8中删除，产品VT9。</li>
<li>ORDER BY：将VT9中的行按ORDER BY子句中的列列表顺序，生成一个游标(VC10)，生成表TV11，并返回给调用者。</li>
</ol>
<h1 id="索引数据结构"><a href="#索引数据结构" class="headerlink" title="索引数据结构"></a>索引数据结构</h1><p>关于mysql B+树索引介绍，需要先把二叉查找树，平衡二叉树和B树做简单介绍，也是这章目的。</p>
<h2 id="二叉查找树"><a href="#二叉查找树" class="headerlink" title="二叉查找树"></a>二叉查找树</h2><p>二叉查找树的特点是：左节点都比当前节点小，右节点都比当前节点大。</p>
<p>这个特性在查找过程中是有优势的，因为和当前节点比较，如果小于就遍历左节点，如果大于就遍历右节点。</p>
<p>二叉查找树定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">一棵空树，或者是具有下列性质的二叉树：</span><br><span class="line">（1）若左子树不空，则左子树上所有结点的值均小于它的根结点的值；</span><br><span class="line">（2）若右子树不空，则右子树上所有结点的值均大于它的根结点的值；</span><br><span class="line">（3）左、右子树也分别为二叉排序树；</span><br><span class="line">（4）没有键值相等的结点。</span><br></pre></td></tr></table></figure>

<p>二叉查找树是二叉树的特例，所以每个节点其实只会存一个键值和数据，因为每次查询都是二分查询，会比顺序查找快。</p>
<h2 id="平衡二叉树"><a href="#平衡二叉树" class="headerlink" title="平衡二叉树"></a>平衡二叉树</h2><p>平衡二叉树的定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 必须为二叉查找树</span><br><span class="line">2. 每个节点的左右子树高度差至多为1</span><br></pre></td></tr></table></figure>

<p>举例看下图：</p>
<p><img alt data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@v1.1/photos/two_balance.jfif" class="lozad"></p>
<p>左边的树 45 那个节点，左边有44 43两个节点，但右边没有节点，所以这个高度差为2，是非平衡二叉树</p>
<p>右边的树每个节点都符合高度差至多为1的条件，所以为平衡二叉树</p>
<p>平衡二叉树之所以可以保持高度差至少为1，在于这是一颗会旋转的树，关于其算法实现，后面博客实现并会列到算法标签</p>
<h2 id="B树"><a href="#B树" class="headerlink" title="B树"></a>B树</h2><p>上面说到，二叉查找树的每个节点只会保存一个键值和数据，这对于大数据量来说是致命的，因为当数据量过大的时候，树的高度简直无法预估。而我们知道，内存的读取效率是远高于磁盘的，所以我们希望每次从磁盘读取数据的时候，可以尽可能多的把数据读到内存处理，但二叉树的特性会使读到内存的数据受限，所以我们希望有个数据结构可以尽可能多的把键值读到内存。这是B树来源</p>
<p>B树其实是平衡n叉查找树，这里的B指的是Balance，B树定义为（M代表节点有多少个查找路径）：</p>
<ol>
<li>根节点至少有两个子女</li>
<li>每个非根节点包含关键字个数满足：大于等于ceil(m/2)-1个且小于等于M-1个（ceil(1.1)为2）</li>
<li>除根节点以外的所有节点（不包含叶子节点）查找路径是关键字+1，故满足：大于等于ceil(m/2)个且小于等于M个（ceil(1.1)为2）</li>
<li>所有叶子节点都在同一层</li>
</ol>
<p>举例：</p>
<p><img alt data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@v1.1/photos/B_tree_photo1.png" class="lozad"></p>
<p>用上面这个图来解释B树定义：</p>
<p>首先图里的这是一个4阶B树，原因是<code>11 12</code>|<code>14 15</code>|<code>17 18</code>|<code>20 21</code>，这四个节点是最多的</p>
<ol>
<li>根节点是10那个节点</li>
<li>非根节点关键个数：<code>3 6</code>|<code>13 16 19</code> 这两个节点就是关键个数的值。通过公式计算得：<blockquote>
<p>ceil(4/2) - 1 =&lt; 关键个数 &lt;= 4-1  即： 1&lt;=关键个数&lt;=3</p>
</blockquote>
</li>
<li>查找路径就是<code>13 16 19</code>链接的那四个子节点和<code>3 6</code>的三个子节点，查找路径满足关键字范围+1：即 <blockquote>
<p>2&lt;=查找路径&lt;=4</p>
</blockquote>
</li>
<li>所有子节点都在同一层，最后一行就是都在同一层</li>
</ol>
<h2 id="B-树"><a href="#B-树" class="headerlink" title="B+树"></a>B+树</h2><p>B+树是B树的升级版本，它的定义为：</p>
<ol>
<li>每个节点至多m个子女</li>
<li>除根节点，每个节点至少有m/2个子女，根节点至少2个子女</li>
<li>有k个子女的节点必然有k个关键字</li>
</ol>
<p>B+树和B树的区别：</p>
<ol>
<li>有K个子节点的节点就必然有k个关键字</li>
<li>非叶节点具有索引作用，记录信息存在叶子节点</li>
<li>树的叶子节点构成一个有序链表，可以按照关键字排序遍历</li>
</ol>
<h1 id="介绍B-树和mysql页概念"><a href="#介绍B-树和mysql页概念" class="headerlink" title="介绍B+树和mysql页概念"></a>介绍B+树和mysql页概念</h1><p>在介绍mysql B+树的概念前，需要先对mysql的页概念有个大致了解</p>
<h2 id="mysql页概念"><a href="#mysql页概念" class="headerlink" title="mysql页概念"></a>mysql页概念</h2><p>mysql的数据存储最小单位为页，一页默认16k（可设置），操作系统默认页为4k，扇区默认512B。</p>
<p>每个页之间是通过双向指针进行连接，页里面的是一个单链表，链表节点是一行一行的数据。每个页都有它自身的属性，像B+树的非叶子节点就是存目录项记录的页。</p>
<p>每4行数据会划分一个槽，当查找数据的时候，我们可以通过二分查找槽的位置快速查找数据位置，大概过程为：</p>
<ol>
<li>通过二分法确认记录所在的槽，并找到和对比该槽最小记录，直到找到符合要求的槽</li>
<li>通过记录的next_record属性遍历槽内数据</li>
</ol>
<p>关于页的具体介绍，我会单独写篇文章，页的图示如下：</p>
<p><img alt data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@v1.1/photos/16a01bd1b8eafbb4" class="lozad"></p>
<h2 id="mysql的B-树"><a href="#mysql的B-树" class="headerlink" title="mysql的B+树"></a>mysql的B+树</h2><p>关于B+树，上面其实已经简单介绍过了，并且结合mysql的页概念，关于B+树的工作原理也就不会难理解</p>
<p>mysql B+树查询工作原理：</p>
<ol>
<li>从根节点开始遍历</li>
<li>根据条件二分查找选择不同的子节点，最后到叶子节点</li>
<li>叶子节点进行二分查找找到对应的值</li>
</ol>
<p>mysql B+树插入情况：</p>
<blockquote>
<p>leaf page：叶子节点 || index page：内部节点</p>
</blockquote>
<table>
<thead>
<tr>
<th>leaf page满</th>
<th>index page满</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>no</td>
<td>no</td>
<td>直接将记录插入叶子节点</td>
</tr>
<tr>
<td>yes</td>
<td>no</td>
<td><code>1.拆分leaf page</code> <code>2. 将中间的节点放入index page中</code> <code>3.小于中间节点的放左边</code> <code>4.大于等于中间节点记录放右边</code></td>
</tr>
<tr>
<td>yes</td>
<td>no</td>
<td><code>1.拆分leaf page</code> <code>2.小于中间节点的记录放左边</code> <code>3.大于等于中间节点的记录放右边</code> <code>4.拆分index page</code> <code>5.小于中间节点的记录放左边</code> <code>6.大于中间节点记录放右边</code> <code>7.中间节点放上一层index page</code></td>
</tr>
</tbody></table>
<blockquote>
<p>这里还有一种情况，当叶子节点的左右节点数据没有满时，会做左右旋转（即把数据全部左移或者右移），以避免页分裂</p>
</blockquote>
<p>介绍完B+树原理，我们先来看个面试题：</p>
<p><code>1) 为什么要用B+树构建索引，而不是B树：</code></p>
<ol>
<li>因为B树非叶子节点也存数据，会增加树的高度，导致更多的io开销，查询性能更低</li>
<li>B+树范围查找只需要遍历子节点，但B树不行</li>
<li>B+树的查询效率更稳定，因为叶子节点存数据，非叶子节点存索引，查询不同的数据查询路径长度相同</li>
</ol>
<p><code>2) 一棵B+树可以添加多少数据？</code></p>
<p>叶子节点：假设一行数据为1k，则一页可以存16行数据<br>非叶子节点：假设主键为bigint类型，占8各字节，指针大小默认为6字节，一行占14字节，那非叶子节点一页可以存16384/14=1170条数据</p>
<p>所以：<br>一颗高度为2的B+树可以存 1170<em>16 = 18720条数据<br>一颗高度为3的B+树可以存 1170</em>1170*16 = 21902400 条数据<br>3层高的树就可以存千万级数据</p>
<p>（page number为3的代表主键索引的根页，page number为4的默认为二级索引）</p>
<p><code>3) mysql为什么把节点大小设置成系统页的整数倍？</code></p>
<p>磁盘读取会发生预读，预读的范围就是页的整数倍。很多Os系统页的大小为4k，主存和磁盘以页为单位交换数据。当程序读取数据不在主存时，会发生缺页异常，并从磁盘中读取连续几页的数据。这样mysql的节点可以在一次IO就读到内存中</p>
<h1 id="innodb和myisam的索引"><a href="#innodb和myisam的索引" class="headerlink" title="innodb和myisam的索引"></a>innodb和myisam的索引</h1><p>innodb和myisam索引叶子节点存储的数据不一样，主要原因在于两者的存储引擎特性不一致导致。</p>
<h2 id="myisam的索引"><a href="#myisam的索引" class="headerlink" title="myisam的索引"></a>myisam的索引</h2><h3 id="主键索引"><a href="#主键索引" class="headerlink" title="主键索引"></a>主键索引</h3><p>MyISAM引擎使用B+树作为索引结果，叶节点的data域存放的是数据记录的地址</p>
<p><img alt data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@v1.1/photos/myisam_primary_photo.png" class="lozad"></p>
<h3 id="辅助索引"><a href="#辅助索引" class="headerlink" title="辅助索引"></a>辅助索引</h3><p>在MyISAM中，主索引和辅助索引在结构上没有任何区别，只是主索引要求key是唯一的，而辅助索引的key可以重复</p>
<p><img alt data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@v1.1/photos/myisam_second_photo.png" class="lozad"></p>
<h2 id="innodb的索引"><a href="#innodb的索引" class="headerlink" title="innodb的索引"></a>innodb的索引</h2><h3 id="innodb的主键索引"><a href="#innodb的主键索引" class="headerlink" title="innodb的主键索引"></a>innodb的主键索引</h3><p>innodb的主键索引又叫聚簇索引，原因是：innodb叶节点存的是完整记录</p>
<p><img alt data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@v1.1/photos/innodb_primary_photo.png" class="lozad"></p>
<h3 id="innodb的辅助索引"><a href="#innodb的辅助索引" class="headerlink" title="innodb的辅助索引"></a>innodb的辅助索引</h3><p>innodb的辅助索引叶节点存的是索引值和主键值</p>
<p><img alt data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@v1.1/photos/innodb_second_photo.png" class="lozad"></p>
<p>如果利用辅助索引进行查询的话，需要做回表操作，即先通过辅助索引找到对应的主键，然后通过主键再回到主键索引进行查询，返回最后的记录。如果辅助索引的高度为3，主键索引高度也为3，最后就需要6次IO操作</p>
<p>索引的查询是顺序IO（原因是表空间在申请的时候是尽可能连续空间），所以效率很快，但回表操作是随机IO，所以当需要回表的数据特别大的时候，其实也是耗时的</p>
<h3 id="innodb的联合索引"><a href="#innodb的联合索引" class="headerlink" title="innodb的联合索引"></a>innodb的联合索引</h3><p>联合索引是指对表上多个列进行建立索引。联合索引构建的索引是要按照建立索引时候的顺序进行排序构建B+树的，所以构建索引时候的字段顺序需要注意，后面优化会讲到。</p>
<p>举例：</p>
<p>给字段 name,age 做联合索引</p>
<table>
<thead>
<tr>
<th>name</th>
<th>age</th>
</tr>
</thead>
<tbody><tr>
<td>精进马大使</td>
<td>18</td>
</tr>
<tr>
<td>精进马大使2号</td>
<td>22</td>
</tr>
<tr>
<td>江仕锴</td>
<td>24</td>
</tr>
<tr>
<td>吴彦祖</td>
<td>28</td>
</tr>
</tbody></table>
<p>最后生成的B+树这样排序：</p>
<p><code>精进马大使|18</code>-&gt; <code>精进马大使2号|22</code> -&gt; <code>江仕锴|24</code> -&gt; <code>吴彦祖|28</code></p>
<blockquote>
<p>先按name排序，再按age排序</p>
</blockquote>
<h3 id="innodb的覆盖索引"><a href="#innodb的覆盖索引" class="headerlink" title="innodb的覆盖索引"></a>innodb的覆盖索引</h3><p>覆盖索引指的是：索引值在sql语句的所选字段里面。官方的语言就是<code>从辅助索引中就可以直接得到查询的记录</code>，这样的好处在不需要回表，而且辅助索引的信息少，可以减少IO操作</p>
<p>举例：</p>
<p>c1,c2是t1的索引，所以下面是覆盖索引场景：</p>
<blockquote>
<p>select c1,c2 from t1 where c1 = ‘b’ and c2 = ‘a’</p>
</blockquote>
<h3 id="innodb的哈希索引"><a href="#innodb的哈希索引" class="headerlink" title="innodb的哈希索引"></a>innodb的哈希索引</h3><p>InnoDB存储引擎使用哈希算法来对字典进行查找，哈希碰撞采用转链表解决，哈希函数采用除法散列方式。对等值查询很快，对范围查询无能为力</p>
<h2 id="索引代价和使用条件"><a href="#索引代价和使用条件" class="headerlink" title="索引代价和使用条件"></a>索引代价和使用条件</h2><h3 id="代价"><a href="#代价" class="headerlink" title="代价"></a>代价</h3><ol>
<li>空间上的代价<blockquote>
<p>每建立一个索引，都会构建一个B+树，每棵B+树的每个节点都是一个数据页，一页默认16k，每棵树有多个数据页</p>
</blockquote>
</li>
<li>时间代价<blockquote>
<p>上面页的概念中讲到，索引的构成是页之间双向链表顺序连接，页里面的记录是单向链表顺序连接，但每次增删改的时候，都会打破顺序，需要重排序，所以存储引擎需要额外时间做记录移位（页分裂、页回收），每个索引对应的B+树都要做相关操作，索引多了自然需要耗费时间在这上面</p>
</blockquote>
</li>
</ol>
<h3 id="适用条件"><a href="#适用条件" class="headerlink" title="适用条件"></a>适用条件</h3><p>我们拿上面联合索引的例子来看适用条件：</p>
<p>假设表名为test1</p>
<table>
<thead>
<tr>
<th>name</th>
<th>age</th>
</tr>
</thead>
<tbody><tr>
<td>精进马大使</td>
<td>18</td>
</tr>
<tr>
<td>精进马大使2号</td>
<td>22</td>
</tr>
<tr>
<td>江仕锴</td>
<td>24</td>
</tr>
<tr>
<td>吴彦祖</td>
<td>28</td>
</tr>
</tbody></table>
<p>构建联合索引：</p>
<p><code>精进马大使|18</code>-&gt; <code>精进马大使2号|22</code> -&gt; <code>江仕锴|24</code> -&gt; <code>吴彦祖|28</code></p>
<ol>
<li>全值匹配</li>
</ol>
<p>全值匹配中，用and连接的各索引顺序不影响查询结果，因为有优化器的作用</p>
<ol start="2">
<li>匹配左边列</li>
</ol>
<p>用到索引：</p>
<blockquote>
<p>select * from test1 where name = ‘精进马大使’<br>select * from test1 where name = ‘精进马大使’ and age = ‘18’</p>
</blockquote>
<p>用不到索引：</p>
<blockquote>
<p>select * from test1 where age = ‘18’</p>
</blockquote>
<p>原因：<code>因为是按照从左到右建立索引顺序，如果不按从左到右使用索引，它无法获取第二个索引的排序状态</code></p>
<ol start="3">
<li>匹配列前缀</li>
</ol>
<p>用到索引：</p>
<blockquote>
<p>select * from test1 where name like ‘精进%’</p>
</blockquote>
<p>用不到索引：</p>
<blockquote>
<p>select * form test1 where name like ‘%精进’</p>
</blockquote>
<p>原因：<code>索引是按照前缀进行排序的，如果前缀确认可以用索引定位，如果前缀不确认无法用到索引</code></p>
<ol start="4">
<li>匹配范围值</li>
</ol>
<p>用到索引：</p>
<blockquote>
<p>select * from test1 where name &gt; ‘精进马大使’ and name &lt; ‘吴彦祖’</p>
</blockquote>
<p>用不到索引：</p>
<blockquote>
<p>select * from test1 where name &gt; ‘精进马大使’ and name &lt; ‘吴彦祖’ and age &gt; ‘20’</p>
</blockquote>
<p>原因：<code>如果前面索引用了范围匹配，后面的索引会用不上，还是索引排序的原因</code></p>
<ol start="5">
<li>精确匹配某一列，范围查询另一列</li>
</ol>
<p>用到索引：</p>
<blockquote>
<p>select * from test1 where name = ‘精进马大使’ and age &gt; ‘18’</p>
</blockquote>
<ol start="6">
<li>用于排序和分组</li>
</ol>
<p>正常order by会把数据读到内存然后用排序算法进行排序（快排、归并等），如果内存不够，则会借助磁盘空间存放中间结果。这个过程叫文件排序</p>
<p>但如果order by索引列，因为索引自身就是排序的，所以返回会很快。分组也一样</p>
<ol start="7">
<li><p>用到表达式和函数处理列的，无法用到索引</p>
</li>
<li><p>优化关联语句</p>
</li>
</ol>
<p>关联语句的后面列如果是索引列，会加速定位。因为关联语句前面列会被遍历，后面列会利用前面遍历出来的值做等值定位</p>
<blockquote>
<p>select * from test1 join test2 on test1.name = test2.name</p>
</blockquote>
<p>这里会遍历test1.name的值，并把值传递给test2.name，test2.name利用值进行等值查询</p>
<h1 id="innodb中的索引优化和场景优化方案"><a href="#innodb中的索引优化和场景优化方案" class="headerlink" title="innodb中的索引优化和场景优化方案"></a>innodb中的索引优化和场景优化方案</h1><h2 id="不使用null的原因"><a href="#不使用null的原因" class="headerlink" title="不使用null的原因"></a>不使用null的原因</h2><ol>
<li>NOT IN、!= 等负向条件查询在有 NULL值的情况下返回永远为空结果，查询容易出错<blockquote>
<p>select * from t1 where c1 not in null：会返回空</p>
</blockquote>
</li>
<li>NULL值到非NULL的更新无法做到原地更新，更容易发生索引分裂，从而影响性能（这个带来的性能问题很小）</li>
<li>NULL会使索引、索引统计和值更加复杂，并且需要额外一个字节的存储空间</li>
</ol>
<h2 id="count的使用"><a href="#count的使用" class="headerlink" title="count的使用"></a>count的使用</h2><p>count(*)：全部行<br>count(列)：不包含null的行</p>
<h2 id="索引优化汇总"><a href="#索引优化汇总" class="headerlink" title="索引优化汇总"></a>索引优化汇总</h2><ol>
<li>只为用于搜索、排序或分组的列创建索引</li>
<li>为列的基数大的列创建索引</li>
<li>索引列的类型尽量小</li>
<li>可以只对字符串值的前缀建立索引</li>
<li>只有索引列在比较表达式中单独出现才可以适用索引</li>
<li>为了尽可能少的让聚簇索引发生页面分裂和记录移位的情况，建议让<code>主键拥有AUTO_INCREMENT属性</code>。</li>
<li>定位并删除表中的重复和冗余索引</li>
<li>尽量使用<code>覆盖索引</code>进行查询，<code>避免回表</code>带来的性能损耗。</li>
</ol>
<h3 id="为什么性别不能用作索引"><a href="#为什么性别不能用作索引" class="headerlink" title="为什么性别不能用作索引"></a>为什么性别不能用作索引</h3><p>这个点主要应对第二个点，列基数大的列建立索引才有用，性别基数小，只有2，所以没啥用，那为啥？核心答案是会产生更多IO</p>
<p>myisam存储引擎：</p>
<blockquote>
<p>因为索引记录的是内存地址，如果为性别建立索引，会为大范围记录进行内存地址的IO查找，这样的查询不如顺序遍历扫描全表快</p>
</blockquote>
<p>innodb存储引擎：</p>
<blockquote>
<p>如果性别列是辅助索引，这时候还需要回表操作，什么是回表操作？上面辅助索引有讲。回表操作时随机IO，性别基数小，会有大批记录需要回表，这时候随机IO就不如全表扫描的顺序IO来的快。</p>
</blockquote>
<p><code>但是innodb中，如果性别做聚簇索引，效率会有提升，因为可以用索引快速定位到整行数据</code></p>
<hr>
<center>创作不易，谢谢你的支持~~</center>
<center class="half">
    <img width="300" data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/wechat_shikai.jpg" class="lozad">
    <img width="300" data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/alipay_shikai.jpg" class="lozad">
</center></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined" target="_blank" rel="noopener">精进马大使</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://jskblog.xyz/posts/f9d59ed2/">http://jskblog.xyz/posts/f9d59ed2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://jskblog.xyz">精进马大使</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/mysql/">mysql    </a><a class="post-meta__tags" href="/tags/%E7%B4%A2%E5%BC%95/">索引    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/jingjin_1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/wechat_shikai.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/alipay_shikai.jpg"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/posts/91f0cf3/"><img class="prev_cover lozad" data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/jingjin_1.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>JVM OOM 汇总及介绍</span></div></a></div><div class="next-post pull-right"><a href="/posts/cdbb5827/"><img class="next_cover lozad" data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/jingjin_1.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>mysql锁机制优化汇总</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/cdbb5827/" title="mysql锁机制优化汇总"><img class="relatedPosts_cover lozad"data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/jingjin_1.jpg"><div class="relatedPosts_title">mysql锁机制优化汇总</div></a></div><div class="relatedPosts_item"><a href="/posts/1c92a0d/" title="mysql事务隔离和mvcc"><img class="relatedPosts_cover lozad"data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/jingjin_1.jpg"><div class="relatedPosts_title">mysql事务隔离和mvcc</div></a></div><div class="relatedPosts_item"><a href="/posts/9aa2b4bd/" title="mysql explain简介"><img class="relatedPosts_cover lozad"data-src="https://cdn.jsdelivr.net/gh/JSK520/blog_web@1.1/photos/jingjin_1.jpg"><div class="relatedPosts_title">mysql explain简介</div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = false == true ? true : false;
var verify = false == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'SWSiPXFxVqui6FGyRkPnCH8H-gzGzoHsz',
  appKey:'6CXuzjRmitpm3VEYvkC1uO2b',
  placeholder:'Please leave your footprints',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'30',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></div><footer><div id="footer"><div class="copyright">&copy;2019 - 2020 By 精进马大使</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script async src="/js/search/local-search.js"></script><script src="/js/nightshift.js"></script><script color="0,0,255" opacity="0.7" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN/js/canvas-nest.js"></script><script src="/js/baidupush.js"> </script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>